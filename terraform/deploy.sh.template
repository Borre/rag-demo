#!/bin/bash

# Radiology Triage AI Deployment Script
# This script will be executed on the ECS instance

set -e

echo "Starting deployment of Radiology Triage AI..."

# Update system packages
apt-get update
apt-get upgrade -y

# Install Docker and Docker Compose
apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release \
    git

# Add Docker's official GPG key
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Set up Docker repository
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install Docker Engine
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io

# Install Docker Compose
curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# Create application directory
mkdir -p /opt/${project_name}
cd /opt/${project_name}

# Clone the application repository (replace with your actual repo)
git clone https://github.com/your-org/radiology-triage-ai.git .

# Create environment file
cat > .env << EOF
# Database Configuration
DB_HOST=${db_host}
DB_PORT=${db_port}
DB_NAME=${db_name}
DB_USER=${db_user}
DB_PASSWORD=${db_password}

# DeepSeek API Configuration
DEEPSEEK_API_KEY=${deepseek_api_key}
DEEPSEEK_BASE_URL=${deepseek_base_url}

# Environment
PYTHONIOENCODING=utf-8
LANG=C.UTF-8
LC_ALL=C.UTF-8
EOF

# Build and start the application
echo "Building Docker containers..."
docker-compose -f ${docker_compose_file} build

echo "Starting application..."
docker-compose -f ${docker_compose_file} up -d

# Wait for application to be ready
echo "Waiting for application to start..."
sleep 30

# Check if application is running
if docker-compose -f ${docker_compose_file} ps | grep -q "Up"; then
    echo "✅ Application deployed successfully!"
    echo ""
    echo "Application is running at: http://$(curl -s ifconfig.me):5000"
    if [ "${deploy_n8n}" = "true" ]; then
        echo "N8N is running at: http://$(curl -s ifconfig.me):5678"
    fi
    echo ""
    echo "Useful commands:"
    echo "  View logs: docker-compose -f ${docker_compose_file} logs -f"
    echo "  Stop app: docker-compose -f ${docker_compose_file} down"
    echo "  Update app: git pull && docker-compose -f ${docker_compose_file} up --build -d"
else
    echo "❌ Application failed to start. Check logs:"
    docker-compose -f ${docker_compose_file} logs
    exit 1
fi

# Create systemd service for auto-start
cat > /etc/systemd/system/radiology-ai.service << EOF
[Unit]
Description=Radiology AI Triage System
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/${project_name}
ExecStart=/usr/local/bin/docker-compose -f ${docker_compose_file} up -d
ExecStop=/usr/local/bin/docker-compose -f ${docker_compose_file} down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

# Enable and start the service
systemctl enable radiology-ai.service
systemctl start radiology-ai.service

# Set up log rotation
cat > /etc/logrotate.d/docker-compose << EOF
/opt/${project_name}/logs/*/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 0644 root root
    postrotate
        docker-compose -f /opt/${project_name}/${docker_compose_file} restart
    endscript
}
EOF

echo "✅ Deployment completed successfully!"
echo ""
echo "The application will automatically start on system reboot."